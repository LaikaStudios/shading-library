##
##  Copyright(c) 2011-2012 Laika, developed under contract by mitchpraterLLC.
##  All rights reserved unless otherwise granted. This program or documentation
##  contains proprietary, confidential information and trade secrets of Laika
##  and/or mitchpraterLLC. Use of copyright notice does not imply publication.
##  
##  By possessing this software, you agree to the following terms and conditions.
##  You may not resell this software, but you may freely distribute it to others.
##  You may use it for whatever purposes you wish. There are no warranties of any
##  kind. You may make modifications, however any derivation may only be distributed
##  to others under the same freedoms granted to you herein, it must retain this
##  notice and agreement, and the modifications noted. We also ask that you make
##  such modifications available to Laika, mitchpraterLLC, or to the computer
##  graphics community as a whole through a public forum.
##
slim 1 extensions mprater {
  extensions laika vfx {

    templateV color SSDiffuse 1 {
        description {
            Reads the _ssdiffusion data channel of a point data file,
            such as the type created by an RMS SSDiffuse Pass.
        }

        slimattribute string FileMethod {
            label {File Method}
            description {
                Selects the method you'll use to specify the point data file.
                You can use the Pass Name, and RMS will infer the file name generated by that pass,
                or you can explicity specify the File Name.
            }
            subtype selector
            range {
                "Pass Name" PassName
                "File Name" FileName
            }
            default PassName

            msghandler {
                SetValue - RevertValue {
                    set paramVal [%obj GetValue]
                    set app [%obj GetAppearance]

                    switch $paramVal {
                        PassName {
                            [$app GetProperties -name PassName] SetDisplayLevel ""
                            [$app GetProperties -name FileName] SetDisplayLevel "hidden"
                        }
                        FileName {
                            [$app GetProperties -name PassName] SetDisplayLevel "hidden"
                            [$app GetProperties -name FileName] SetDisplayLevel ""
                        }
                    }

                    $app UpdateEditor
                }
            }
        }

        parameter string PassName {
            label {Pass Name}
            description {
                The name of the SSDiffuse Pass you want to read data from.
            }
            provider variable
            detail varying
            default {rmanSSDiffusePass}

            msghandler {
                SetValue - RevertValue {
                    set passName [%obj GetValue]
                    set app [%obj GetAppearance]

                    set fileParam [$app GetProperties -name PassFileName]
                    $fileParam SetValue "\[PassFileName $passName\]"

                    $app UpdateEditor
                }
            }
        }
        parameter string PassFileName {
            display hidden
            description {
                The file specification defined by the PassName parameter.
            }
            provider variable
            default {[PassFileName rmanSSDiffusePass]}
        }

        parameter string FileName {
            label {File Name}
            display hidden
            description {
                The name of a diffusion point data file: one that contains an _ssdiffusion data channel.
                You can also refer to an SSDiffuse Pass file with something
                like [PassFileName rmanSSDiffusePass].
            }
            subtype file
            provider variable
            detail varying
            default {[PassFileName rmanSSDiffusePass]}
        }

        parameter color _ssdiffusion {
            display hidden
            access output
        }

        RSLInclude {slim.h}

        RSLSource DynamicFunction {
            proc primvars {} {}
            proc function {} {
                generateBody {
output "
                    _ssdiffusion = color 0;

                    uniform string  file = \"\";
"
                    if {[getval FileMethod] == "PassName"} {
output "
                        // Skip file reads if we're rendering the pass that generates the file.
                        uniform string  pass_id = \"\";
                        option (\"user:pass_id\", pass_id);
                        if (pass_id == [getvar PassName])
                            return;

                        file = [getvar PassFileName];
"
                    } else {
output "                file = [getvar FileName];"
                    }
output "
                    uniform float   dummy;
                    if (textureinfo (file, \"exists\", dummy) == 0)
                        return;

                    texture3d (file, SLIM_P, N, \"_ssdiffusion\", _ssdiffusion);
"
                }
            }
        }
    }

  }
}
