##
##  Copyright(c) 2011-2012 Laika, developed under contract by mitchpraterLLC.
##  All rights reserved unless otherwise granted. This program or documentation
##  contains proprietary, confidential information and trade secrets of Laika
##  and/or mitchpraterLLC. Use of copyright notice does not imply publication.
##  
##  By possessing this software, you agree to the following terms and conditions.
##  You may not resell this software, but you may freely distribute it to others.
##  You may use it for whatever purposes you wish. There are no warranties of any
##  kind. You may make modifications, however any derivation may only be distributed
##  to others under the same freedoms granted to you herein, it must retain this
##  notice and agreement, and the modifications noted. We also ask that you make
##  such modifications available to Laika, mitchpraterLLC, or to the computer
##  graphics community as a whole through a public forum.
##
slim 1 extensions mprater {
  extensions laika vfx {

    templateV multiple RenderRadiosity 1 {
        description {
            Reads the _radiosity, _area, and Cs data channels of a point data file,
            such as the type created by an RMS RenderRadiosity Pass.
        }

        slimattribute string FileMethod {
            label {File Method}
            description {
                Selects the method you'll use to specify the point data file.
                You can use the Pass Name, and RMS will infer the file name generated by that pass,
                or you can explicity specify the File Name.
            }
            subtype selector
            range {
                "Pass Name" PassName
                "File Name" FileName
            }
            default PassName

            msghandler {
                SetValue - RevertValue {
                    set paramVal [%obj GetValue]
                    set app [%obj GetAppearance]

                    switch $paramVal {
                        PassName {
                            [$app GetProperties -name PassName] SetDisplayLevel ""
                            [$app GetProperties -name FileName] SetDisplayLevel "hidden"
                        }
                        FileName {
                            [$app GetProperties -name PassName] SetDisplayLevel "hidden"
                            [$app GetProperties -name FileName] SetDisplayLevel ""
                        }
                    }

                    $app UpdateEditor
                }
            }
        }

        parameter string PassName {
            label {Pass Name}
            description {
                The name of the RenderRadiosity Pass you want to read data from.
            }
            provider variable
            detail varying
            default {rmanRenderRadiosityPass}

            msghandler {
                SetValue - RevertValue {
                    set passName [%obj GetValue]
                    set app [%obj GetAppearance]

                    set fileParam [$app GetProperties -name PassFileName]
                    $fileParam SetValue "\[PassFileName $passName\]"

                    $app UpdateEditor
                }
            }
        }
        parameter string PassFileName {
            display hidden
            description {
                The file specification defined by the PassName parameter.
            }
            provider variable
            default {[PassFileName rmanRenderRadiosityPass]}
        }

        parameter string FileName {
            label {File Name}
            display hidden
            description {
                The name of a radiosity point data file.
                You can also refer to a RenderRadiosity Pass file with something
                like [PassFileName rmanRenderRadiosityPass].
            }
            subtype file
            provider variable
            detail varying
            default {[PassFileName rmanRenderRadiosityPass]}
        }

        parameter color _radiosity {
            label {_radiosity}
            display hidden
            access output
        }

        parameter float _area {
            label {_area}
            display hidden
            access output
        }

        parameter color _Cs {
            label {Cs}
            display hidden
            access output
        }

        RSLInclude {slim.h}

        RSLSource DynamicFunction {
            proc primvars {} {}
            proc function {} {
                generateBody {
output "
                    _radiosity = color 0;
                    _area = 0;
                    _Cs = color 0;

                    uniform string  file = \"\";
"
                    if {[getval FileMethod] == "PassName"} {
output "
                        // Skip file reads if we're rendering the pass that generates the file.
                        uniform string  pass_id = \"\";
                        option (\"user:pass_id\", pass_id);
                        if (pass_id == [getvar PassName])
                            return;

                        file = [getvar PassFileName];
"
                    } else {
output "                file = [getvar FileName];"
                    }
output "
                    uniform float   dummy;
                    if (textureinfo (file, \"exists\", dummy) == 0)
                        return;

                    texture3d (file, SLIM_P, N, \"_area\", _area, \"_radiosity\", _radiosity, \"Cs\", _Cs);
"
                }
            }
        }
    }

  }
}
