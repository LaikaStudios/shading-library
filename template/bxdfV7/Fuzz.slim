##
##  Copyright(c) 2012-2014 Laika, developed under contract by mitchpraterLLC.
##  All rights reserved unless otherwise granted. This program or documentation
##  contains proprietary, confidential information and trade secrets of Laika
##  and/or mitchpraterLLC. Use of copyright notice does not imply publication.
##  
##  By possessing this software, you agree to the following terms and conditions.
##  You may not resell this software, but you may freely distribute it to others.
##  You may use it for whatever purposes you wish. There are no warranties of any
##  kind. You may make modifications, however any derivation may only be distributed
##  to others under the same freedoms granted to you herein, it must retain this
##  notice and agreement, and the modifications noted. We also ask that you make
##  such modifications available to Laika, mitchpraterLLC, or to the computer
##  graphics community as a whole through a public forum.
##
slim 1 extensions mprater {
  extensions laika vfx {

    templateV bxdfV7Fuzz_s bxdfV7Fuzz 0 {
        description {
            A Fuzz response: pseudo-scattering of the illumination in a boundary layer on the surface.
            The fuzz is modeled as fibers oriented in the direction of the shading normal.
        }

        parameter float OnOff {
            label {On Off}
            description {
                Turn this response on or off.
                On(1) = Normal Computation.
                Bypass(0) = Don't show its response in the result.
                Kill(-1) = Remove it from the Material.
                <
            }
            detail varying
            subtype selector
            range {
                "On" 1
                "Bypass" 0
                "Kill" -1
            }
            default 1
        }
        parameter coshader OnOff_Co_ {
            display hidden
            default {}
            value {}
        }

        parameter float NormOnOff {
            label {Normalize On}
            description {
                Does this response participate in the Intensity Normalization within this Layer or not?
                Note that when this is first turned off, the intensities of all the normalized responses
                (including it) will change. But once it's been removed from that computation, further changes
                will not interact with the rest of the responses.
                <
            }
            detail varying
            subtype switch
            default 1
        }
        parameter coshader NormOnOff_Co_ {
            display hidden
            default {}
            value {}
        }

        parameter float Intensity {
            description {
                The Intensity of the response.
                <
            }
            detail varying
            subtype slider
            range {0 2}
            default 1
        }
        parameter coshader Intensity_Co_ {
            display hidden
            default {}
            value {}
        }

        parameter color Color {
            label {Color}
            description {
                The color of the response.
                <
            }
            detail varying
            default {1 1 1}
        }
        parameter coshader Color_Co_ {
            display hidden
            default {}
            value {}
        }

        parameter float ColorMix {
            label {Use Color}
            description {
                Determines how much of the Color is used in the response.
                <
            }
            detail varying
            subtype slider
            range {0 1}
            default 1
        }
        parameter coshader ColorMix_Co_ {
            display hidden
            default {}
            value {}
        }

        parameter float Range {
            description {
                Determines how broadly the surface can respond to incoming light.
                1 means the 180 degree hemisphere above the surface and is the correct value
                for simple, solid surfaces. Larger values increase this range, up to a
                full 360 degrees at 2. Values slightly above 1 are useful for creating
                boundary layer effects where the influence of light can creep beyond the
                simple 180 degree hemisphere horizon.
                In a plausible system, anything greater than 1 may produce hard-edges in the
                response - be careful. Values less than 1 are less and less influenced by illumination.
                <
            }
            detail varying
            subtype slider
            range {.5 2}
            default 1
        }
        parameter coshader Range_Co_ {
            display hidden
            default {}
            value {}
        }

        parameter float Exponent {
            description {
                The response lobe focusing Exponent.
                Larger values decrease the response size and would be associated with a thinner fuzz layer.
                <
            }
            detail varying
            subtype slider
            range {.5 4}
            default 2
        }
        parameter coshader Exponent_Co_ {
            display hidden
            default {}
            value {}
        }

        parameter float MinIntensity {
            label {Min Intensity}
            description {
                Sets the intensity for the darkest part of the response.
                This occurs when looking straight down the fuzz fibers.
                <
            }
            detail varying
            subtype slider
            range {0 1}
            default 0
        }
        parameter coshader MinIntensity_Co_ {
            display hidden
            default {}
            value {}
        }

        collection void NsOverride {
            label {Normal Override}
            description {
                These controls allow you to alter the shading normal that
                will be used. This overrides any bump that's been applied to
                the Material with the Bump Disp parameter.
            }

            parameter float NsInfluence {
                label {Influence}
                description {
                    How much of the alternate Shading Normal is used?
                    This is a mix between the regular normal and the alternate Shading Normal.
                    <
                }
                detail varying
                subtype slider
                range {0 1}
                default 0
            }
            parameter coshader NsInfluence_Co_ {
                display hidden
                default {}
                value {}
            }

            parameter normal Ns {
                label {Shading Normal}
                description {
                    An alternate Shading Normal to use.
                    <
                }
                detail mustvary "pixar,SurfaceNormal"
            }
            parameter coshader Ns_Co_ {
                display hidden
                default {}
                value {}
            }
        }

        collection void1 FresnelOverride {
            label {Fresnel Override}
            description {
                These controls allow you to alter the Fresnel Value that
                will be used. This overrides any Fresnel function that's connected to
                the Material with the Fresnel parameter.
            }

            parameter float FresnelInfluence {
                label {Influence}
                description {
                    How much of the alternate Fresnel Value is used?
                    This is a mix between the connected Fresnel function and the alternate Fresnel Value.
                    <
                }
                detail varying
                subtype slider
                range {0 1}
                default 0
            }
            parameter coshader FresnelInfluence_Co_ {
                display hidden
                default {}
                value {}
            }

            parameter color FresnelValue {
                label {Fresnel Value}
                description {
                    An alternate Fresnel Value to use.
                    <
                }
                detail varying
                default {1 1 1}
            }
            parameter coshader FresnelValue_Co_ {
                display hidden
                default {}
                value {}
            }
        }

        parameter bxdfV7Fuzz_s result {
            display hidden
            access output
        }


#        RSLInclude {bxdfV7/Fuzz.h} -within body

        RSLInclude {color.h}
        RSLInclude {coreV7/override.h}

        RSLSource DynamicFunction {
            proc primvars {} {}
            proc function {} {
                generateBody {

                    set overrideParam "OnOff"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying float _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "NormOnOff"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying float _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "Intensity"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying float _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "Color"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying color _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "ColorMix"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying float _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "Range"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying float _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "Exponent"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying float _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "MinIntensity"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying float _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "NsInfluence"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying float _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "Ns"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying vector _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "FresnelInfluence"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying float _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

                    set overrideParam "FresnelValue"
                    set coParam [safeeval [safeeval %c GetProperties -name "${overrideParam}_Co_"] GetNameSL 1]
                    output "varying color _$overrideParam = overrideV( $coParam, [getvar $overrideParam] );"

output "
                    result->OnOff = _OnOff;
                    result->NormOnOff = _NormOnOff * step( -0.5, _OnOff );  // Do not normalize if killed.
                    result->Intensity = _Intensity;
                    result->Color = _Color;
                    result->ColorMix = _ColorMix;
                    result->Range = _Range;
                    result->Exponent = _Exponent;
                    result->MinIntensity = colorSRGBToLinear(_MinIntensity);
                    result->NsInfluence = _NsInfluence;
                    result->Ns = _Ns;
                    result->FresnelInfluence = _FresnelInfluence;
                    result->FresnelValue = _FresnelValue;
"
                }
            }
        }
    }

  }
}
